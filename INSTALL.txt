TheyWorkForYou.com Installation Instructions 
============================================
$Id: INSTALL.txt,v 1.1 2006-04-27 14:20:19 twfy-live Exp $

TODO: Add an explanation of how to set up a virtual host in apache.

Introduction
============

This file explains how to install a working version of
theyworkforyou.com. I'll assume you have a basic knowledge of apache,
php and mysql.

System Requirements
===================

Perl 5.8.1 
PHP 4.3.3
Apache 1.3.28
MySQL 4.1

Note: it is possible to make the code with 4.0 versions of MySQL, but you have to do some mucking around with character sets. The code does NOT work with PHP 5.

Other sources of help
=====================

Documentation and help is also available from the following:

1. Wiki
 http://wiki.theyworkforyou.com/cgi-bin/moin.cgi

2. publicwhip-playing list:
 http://sourceforge.net/mailarchive/forum.php?forum_id=40780

3. also look out for announcements on http://www.theyworkforyou.com/

Installation
============

NOTE: 
  I assume you will set this up to run as a NAME BASED VIRTUAL
  HOST. It's quite possible to set it up without using it's own
  virtual host, but I'll not cover that here.

INSTALLATION SECTION 1 -- THE BASICS
====================================
1. download the latest versions of BOTH theyworkforyou and publicwhip
   source code packages from sourceforge.
http://sourceforge.net/project/showfiles.php?group_id=87640

2. untar the packages to wherever you want them to live, e.g.:

$ cd /var/www/
$ tar zxf theyworkforyou-source-5.tar.gz
$ tar zxf publicwhip-source-5.tar.gz

these will explode into directories name theyworkforyou-source-5 and
publicwhip-source-5.

I'll assume that you're lazy like me and prefer to type shorter
things, so rename these dirs:

$ mv theyworkforyou-source-5 theyworkforyou
$ mv publicwhip-source-5 publicwhip

3. create a new mysql database:

mysqladmin -u root -p create twfy

3. create a user for your database:

grant all on twfy.* to twfy@localhost identified by 'mypass';

4. create database schema. The creation scripts are in the 'db'
   subdirectory of the theyworkforyou source code package.

$ cd db
$ mysql -u twfy -p twfy < hansard.sql
$ mysql -u twfy -p twfy < users.sql

5. Configure the config.php file

In directory
  <theyworkforyou>/www/includes/easyparliament/

You should rename the file:
  config.php.incvs
to 
  config.php

and then edit the following lines to have the following values (or as
appropriate for your setup):

7. configure apache:

If you want to create a virtual host, make sure that the 
NameVirtualHost directive is uncommented and says

NameVirtualHost * 

and then add something like the following, with the paths updated
 for your setup, and restart apache (apachectl restart)

<VirtualHost localether>
 ServerAdmin me@example.com
 DocumentRoot /var/www/theyworkforyou/www/docs
 ServerName twfy.example.com
  <Directory /var/www/theyworkforyou/www/docs>
   Options FollowSymLinks
   AllowOverride All
   Allow from all
   Order allow,deny
  </Directory>

 ErrorLog /var/log/httpd/twfy_error
 CustomLog /var/log/httpd/twfy_access combined
</VirtualHost>

INSTALLATION SECTION 2 -- GETTING SOME DATA
===========================================

In this section we'll populate your mysql database with lots of nice
data about MPs. This will be based on XML format data published by
theyworkforyou.com.

1. download various data from http://www.theyworkforyou.com/pwdata/

You need to preserve the directory structure which exists under
pwdata, but you don't need to get *everything*. Most of the useful
stuff is under scrapedxml, but there are a few other bits needed as
well.

you can use the following script to get what you need. Or otherwise
download it manually, being sure to preserve the directory
structure. Note: this script gets just 1 debate (debates????.xml)
file, 1 register of members interests file (regmem????.xml) and 1
written answers file (answers????.xml). There are large zip files
containing the entire backlog of data if you want it (~75MB for
debates and written answers).

---BEGIN SCRIPT---
#!/bin/sh
mkdir pwdata
cd pwdata
sed 's/^/http:\/\/www.theyworkforyou.com\/pwdata\//' <<HERE | xargs wget 
cmindex.xml
divreport.html
emblinks.txt
faxyourmp-responsiveness.xml
filtertemp.xml
lordindex.xml
parl-recesses.txt
schema.sql
HERE

mkdir scrapedxml
cd scrapedxml
mkdir debates
mkdir regmem
mkdir wrans

wget -O debates/debates2004-11-03.xml http://www.theyworkforyou.com/pwdata/scrapedxml/debates/debates2004-11-03.xml                       
wget -O regmem/regmem2004-10-22.xml http://www.theyworkforyou.com/pwdata/scrapedxml/regmem/regmem2004-10-22.xml
wget -O wrans/answers2004-11-04.xml http://www.theyworkforyou.com/pwdata/scrapedxml/wrans/answers2004-11-04.xml
---END SCRIPT---

2. now you have that data, you are ready to import it into your
   database. You do this using a script called xml2db.pl which is in
   the "scripts" subdir. But first you must configure the config.pm
   file.

3. in the "scripts" subdir, copy config.pm.incvs to config.pm and
   customise the variables to suit your installation. Note, the
   $pwmembers variable should point to the 'members' subdir contained
   in the publicwhip-source-5 package which you unzipped earlier.

# database connection details
$dsn="DBI:mysql:database=twfy:host=localhost"
$user="twfy";
$pass="mypass";

# this is where the XML files come from:
$pwdata = "/var/www/theyworkforyou/pwdata/";
# and where all-members.xml is:
$pwmembers = "/var/www/publicwhip/members/";

4. now run xml2db.pl as follows:

$ ./xml2db.pl --wrans --debates --members --all

That will process all written answers, debates and members. Running
the script with no args gives usage.

**** You should now have a working ****
**** install of theyworkforyou.com ****

Final notes/known issues
========================

1. Features that don't work on development versions.

Due to Movable Type licensing issues the Site News blog is disabled on development versions of the site.

The Postcode lookup service is disabled on development versions. Instead, postcodes are mapped randomly but deterministically to MPs.

2. Search engine:

the search engine relies uses Xapian (http://www.xapian.org/), which
is a search toolkit written in C++. In order to use the search system,
you need to compile the PHP bindings of Xapian. If you don't have
Xapian, you will probably get an error like this when you try to do a
search:

Fatal error: Call to undefined function: new_stem() in
/var/www/theyworkforyou/www/includes/easyparliament/searchengine.php
on line 32

There are some instructions on how to do this here:
  http://lists.tartarus.org/pipermail/xapian-discuss/2004-May/000037.html

