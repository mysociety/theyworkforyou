<?php

/*	Comment reports are when a user complains about a comment.
    A report is logged and an admin user can then either approve or reject
    the report. If they approve, the associated comment is deleted.


    To create a new comment report:
        $REPORT = new COMMENTREPORT;
        $REPORT->create($data);

    To view info about an existing report:
        $REPORT = new COMMENTREPORT($report_id);
        $REPORT->display();

    You can also do $REPORT->lock() and $REPORT->unlock() to ensure only
    one person can process a report at a time.

    And finally you can $REPORT->resolve() to approve or reject the report.

*/

class COMMENTREPORT {

    public $report_id = '';
    public $comment_id = '';
    public $firstname = '';
    public $lastname = '';
    public $body = '';
    public $reported = null;	// datetime
    public $resolved = null; 	// datetime
    public $resolvedby = ''; 	// user_id
    public $locked = null; 	// datetime
    public $lockedby = '';		// user_id
    public $upheld = ''; 		// boolean

    // If the user was logged in, this will be set:
    public $user_id = '';
    // If the user wasn't logged in, this will be set:
    public $email = '';


    public function __construct($report_id='') {
        // Pass it a report id and it gets and sets this report's data.

        $this->db = new ParlDB;

        if (is_numeric($report_id)) {

            $q = $this->db->query("SELECT commentreports.comment_id,
                                    commentreports.user_id,
                                    commentreports.body,
                                    DATE_FORMAT(commentreports.reported, '" . SHORTDATEFORMAT_SQL . ' ' . TIMEFORMAT_SQL . "') AS reported,
                                    DATE_FORMAT(commentreports.resolved, '" . SHORTDATEFORMAT_SQL . ' ' . TIMEFORMAT_SQL . "') AS resolved,
                                    commentreports.resolvedby,
                                    commentreports.locked,
                                    commentreports.lockedby,
                                    commentreports.upheld,
                                    commentreports.firstname,
                                    commentreports.lastname,
                                    commentreports.email,
                                    users.firstname AS u_firstname,
                                    users.lastname AS u_lastname
                            FROM	commentreports,
                                    users
                            WHERE	commentreports.report_id = :report_id
                            AND		commentreports.user_id = users.user_id
                            ", array(
                                ':report_id' => $report_id
                            ))->first();

            if ($q) {
                $this->report_id = $report_id;
                $this->comment_id = $q['comment_id'];
                $this->body = $q['body'];
                $this->reported = $q['reported'];
                $this->resolved = $q['resolved'];
                $this->resolvedby = $q['resolvedby'];
                $this->locked = $q['locked'];
                $this->lockedby = $q['lockedby'];
                $this->upheld = $q['upheld'];

                if ($q['user_id'] == 0) {
                    // The report was made by a non-logged-in user.
                    $this->firstname = $q['firstname'];
                    $this->lastname = $q['lastname'];
                    $this->email = $q['email'];
                } else {
                    // The report was made by a logged-in user.
                    $this->firstname = $q['u_firstname'];
                    $this->lastname = $q['u_lastname'];
                    $this->user_id = $q['user_id'];
                }
            } else {
                $q = $this->db->query("SELECT commentreports.comment_id,
                                    commentreports.user_id,
                                    commentreports.body,
                                    DATE_FORMAT(commentreports.reported, '" . SHORTDATEFORMAT_SQL . ' ' . TIMEFORMAT_SQL . "') AS reported,
                                    DATE_FORMAT(commentreports.resolved, '" . SHORTDATEFORMAT_SQL . ' ' . TIMEFORMAT_SQL . "') AS resolved,
                                    commentreports.resolvedby,
                                    commentreports.locked,
                                    commentreports.lockedby,
                                    commentreports.upheld,
                                    commentreports.firstname,
                                    commentreports.lastname,
                                    commentreports.email
                            FROM	commentreports
                            WHERE	commentreports.report_id = :report_id", array(
                                ':report_id' => $report_id
                            ))->first();
                if ($q) {
                    $this->report_id = $report_id;
                    $this->comment_id = $q['comment_id'];
                    $this->body = $q['body'];
                    $this->reported = $q['reported'];
                    $this->resolved = $q['resolved'];
                    $this->resolvedby = $q['resolvedby'];
                    $this->locked = $q['locked'];
                    $this->lockedby = $q['lockedby'];
                    $this->upheld = $q['upheld'];
                    $this->firstname = $q['firstname'];
                    $this->lastname = $q['lastname'];
                    $this->email = $q['email'];
                }
            }
        }
    }


    public function report_id() { return $this->report_id; }
    public function comment_id() { return $this->comment_id; }
    public function user_id() { return $this->user_id; }
    public function user_name() { return $this->firstname . ' ' . $this->lastname; }
    public function firstname() { return $this->firstname; }
    public function lastname() { return $this->lastname; }
    public function email() { return $this->email; }
    public function body() { return $this->body; }
    public function reported() { return $this->reported; }
    public function resolved() { return $this->resolved; }
    public function resolvedby() { return $this->resolvedby; }
    public function locked() { return $this->locked; }
    public function lockedby() { return $this->lockedby; }
    public function upheld() { return $this->upheld; }

    public function create($COMMENT, $reportdata) {
        // For when a user posts a report on a comment.
        // $reportdata is an array like:
        //	array (
        //		'body' => 'some text',
        //		'firstname'	=> 'Billy',
        //		'lastname'	=> 'Nomates',
        //		'email'		=> 'billy@nomates.com'
        //	)
        // But if the report was made by a logged-in user, only the
        // 'body' element should really contain anything, because
        // we use $THEUSER's id to get the rest.

        // $COMMENT is an existing COMMENT object, needed for setting
        // its modflag and comment_id.

        global $THEUSER, $PAGE;

        if (!$THEUSER->is_able_to('reportcomment')) {
            $PAGE->error_message ("Sorry, you are not allowed to post reports.");
            return false;
        }

        if (is_numeric($THEUSER->user_id()) && $THEUSER->user_id() > 0) {
            // Flood check - make sure the user hasn't just posted a report recently.
            // To help prevent accidental duplicates, among other nasty things.
            // (Non-logged in users are all id == 0.)

            $flood_time_limit = 20; // How many seconds until a user can post again?

            $q = $this->db->query("SELECT report_id
                            FROM	commentreports
                            WHERE	user_id = '" . $THEUSER->user_id() . "'
                            AND		reported + 0 > NOW() - $flood_time_limit");

            if ($q->rows() > 0) {
                $PAGE->error_message("Sorry, we limit people to posting one report per $flood_time_limit seconds to help prevent duplicate reports. Please go back and try again, thanks.");
                return false;
            }
        }


        // Tidy up body.
        $body = filter_user_input($reportdata['body'], 'comment'); // In utility.php

        $time = gmdate("Y-m-d H:i:s");

        if ($THEUSER->isloggedin()) {
            $sql = "INSERT INTO commentreports
                                    (comment_id, body, reported, user_id)
                            VALUES	(:comment_id,
                                    :body,
                                    :time,
                                    :user_id
                                    )
                        ";
            $params = array(
                ':comment_id' => $COMMENT->comment_id(),
                ':body' => $body,
                ':time' => $time,
                ':user_id' => $THEUSER->user_id()
            );
        } else {
            $sql = "INSERT INTO commentreports
                                    (comment_id, body, reported, firstname, lastname, email)
                            VALUES	(:comment_id,
                                    :body,
                                    :time,
                                    :firstname,
                                    :lastname,
                                    :email
                                    )
                        ";
            $params = array(
                ':comment_id' => $COMMENT->comment_id(),
                ':body' => $body,
                ':time' => $time,
                ':firstname' => $reportdata['firstname'],
                ':lastname' => $reportdata['lastname'],
                ':email' => $reportdata['email'],
            );
        }

        $q = $this->db->query($sql, $params);

        if ($q->success()) {
            // Inserted OK, so set up this object's variables.
            $this->report_id 	= $q->insert_id();
            $this->comment_id 	= $COMMENT->comment_id();
            $this->body			= $body;
            $this->reported		= $time;

            if ($THEUSER->isloggedin()) {
                $this->user_id		= $THEUSER->user_id();
                $this->firstname	= $THEUSER->firstname();
                $this->lastname		= $THEUSER->lastname();
            } else {
                $this->email		= $reportdata['email'];
                $this->firstname 	= $reportdata['firstname'];
                $this->lastname		= $reportdata['lastname'];
            }


            // Set the comment's modflag to on.
            $COMMENT->set_modflag('on');


            // Notify those who need to know that there's a new report.

            $URL = new \MySociety\TheyWorkForYou\Url('admin_commentreport');
            $URL->insert(array(
                'rid'=>$this->report_id,
                'cid'=>$this->comment_id
            ));

            $emailbody = "A new comment report has been filed by " . $this->user_name() . ".\n\n";
            $emailbody .= "COMMENT:\n" . $COMMENT->body() . "\n\n";
            $emailbody .= "REPORT:\n" . $this->body . "\n\n";
            $emailbody .= "To manage this report follow this link: https://" . DOMAIN . $URL->generate('none') . "\n";

            send_email(REPORTLIST, 'New comment report', $emailbody);


            // Send an email to the user to thank them.

            if ($THEUSER->isloggedin()) {
                $email = $THEUSER->email();
            } else {
                $email = $this->email();
            }

            $data = array (
                'to' 			=> $email,
                'template' 		=> 'report_acknowledge'
            );
            $merge = array (
                'COMMENTURL' 	=> "https://" . DOMAIN . $COMMENT->url(),
                'REPORTBODY' 	=> strip_tags($this->body())
            );


            // send_template_email in utility.php.
            send_template_email($data, $merge);

            return true;
        } else {
            return false;
        }

    }


    public function display() {

        $data = array();

        if (is_numeric($this->report_id)) {
            $data = array (
                'report_id' 	=> $this->report_id(),
                'comment_id' 	=> $this->comment_id(),
                'user_id' 		=> $this->user_id(),
                'user_name' 	=> $this->user_name(),
                'body' 			=> $this->body(),
                'reported' 		=> $this->reported(),
                'resolved' 		=> $this->resolved(),
                'resolvedby' 	=> $this->resolvedby(),
                'locked' 		=> $this->locked(),
                'lockedby'		=> $this->lockedby(),
                'upheld'	 	=> $this->upheld()
            );
        }

        $this->render($data);
    }



    public function render($data) {
        global $PAGE;

        $PAGE->display_commentreport($data);

    }


    public function lock() {
        // Called when an admin user goes to examine a report, so that
        // only one person can edit at once.

        global $THEUSER, $PAGE;

        if ($THEUSER->is_able_to('deletecomment')) {
            $time = gmdate("Y-m-d H:i:s");

            $q = $this->db->query ("UPDATE commentreports
                            SET		locked = '$time',
                                    lockedby = '" . $THEUSER->user_id() . "'
                            WHERE	report_id = '" . $this->report_id . "'
                            ");

            if ($q->success()) {
                $this->locked = $time;
                $this->lockedby = $THEUSER->user_id();
                return true;
            } else {
                $PAGE->error_message ("Sorry, we were unable to lock this report.");
                return false;
            }
        } else {
            $PAGE->error_message ("You are not authorised to delete annotations.");
            return false;
        }
    }


    public function unlock() {
        // Unlock a comment so it can be examined by someone else.

        $q = $this->db->query ("UPDATE commentreports
                        SET		locked = NULL,
                                lockedby = NULL
                        WHERE	report_id = '" . $this->report_id . "'
                        ");

        if ($q->success()) {
            $this->locked = null;
            $this->lockedby = null;
            return true;
        } else {
            return false;
        }
    }



    public function resolve($upheld, $COMMENT) {
        // Resolve a report.
        // $upheld is true or false.
        // $COMMENT is an existing COMMENT object - we need this so
        // that we can set its modflagged to off and/or delete it.
        global $THEUSER, $PAGE;

        $time = gmdate("Y-m-d H:i:s");

        if ($THEUSER->is_able_to('deletecomment')) {
            // User is allowed to do this.

            if (!$this->resolved) {
                // Only if this report hasn't been previously resolved.

                if ($upheld) {

                    $success = $COMMENT->delete();

                    if (!$success) {
                        // Abort!
                        return false;
                    }

                    $upheldsql = 1;

                } else {
                    $upheldsql = 0;

                    // Report has been removed, so un-modflag this comment.
                    $COMMENT->set_modflag('off');
                }

                $q = $this->db->query("UPDATE commentreports
                                SET 	resolved = :time,
                                        resolvedby = :resolved_by,
                                        locked = NULL,
                                        lockedby = NULL,
                                        upheld = :upheld
                                WHERE 	report_id = :report_id
                                ", array(
                                    ':time' => $time,
                                    ':resolved_by' => $THEUSER->user_id(),
                                    ':upheld' => $upheldsql,
                                    ':report_id' => $this->report_id
                                ));

                if ($q->success()) {

                    $this->resolved = $time;
                    $this->resolvedby = $THEUSER->user_id();
                    $this->locked = null;
                    $this->lockedby = null;
                    $this->upheld = $upheld;

                    return true;
                } else {
                    $PAGE->error_message ("Sorry, we couldn't resolve this report.");
                    return false;
                }
            } else {
                $PAGE->error_message ("This report has already been resolved (on " . $this->resolved . ")");
                return false;
            }

        } else {
            $PAGE->error_message ("You are not authorised to resolve reports.");
            return false;
        }
    }



}

